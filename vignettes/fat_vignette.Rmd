---
title: "Forecasted Average Treatment Effects"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Forecasted Average Treatment Effects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The `fatEstimator` package implements the methodology of Botosaru, Giacomini, and Weidner (2024), designed for settings where no valid control group exists. This includes nationwide reforms, universal policy shifts, and endogenous adoption, where traditional treatment-control comparisons fail.
Rather than relying on comparisons between treated and untreated units, the FAT method forecasts what each treated unit's outcome would have been in the absence of treatment using only its own pre-treatment data.

## The FAT Estimator (Baseline Case)

The forecasted average treatment effect at horizon h is defined as:

$$
\widehat{FAT_h} := \frac{1}{n} \sum_{i \in n} [Y_{i \tau + h} - \widehat{Y}_{i \tau + h}(0)]
$$


where:

- $n$: number of units.
- $Y_{i \tau + h}$: observed outcome for unit $i$ at time $\tau + h$.
- $\widehat{Y}_{i \tau + h}(0)$: measurable function of past outcomes for unit $i$ at time $\tau + h$ using individual-specific pre-treatment outcomes. 

Each estimation follows three steps:

1. Fit pre-treatment model for each unit. 
2. Forecast outcomes at $T*_i + h$
3. Compare the forecasted and actual outcomes. 


## Assumptions and Key Features

- **Forecast Unbiasedness**: Counterfactual forecasts must be unbiased on average.
- **Weak Dependence**: Forecast errors must satisfy a central limit theorem.
- **Basis Function Forecasting**: Forecasts are based on regressions using simple basis functions (e.g., polynomials).
- **Short Panel**: Identification and inference do not require long time series. 

## Advantages

- No control group needed.
- Allows for heterogeneous treatment effects.
- Robust to model misspecification.
- Compatible with short time series.


## Application steps

1. Prepare the data in long format with columns for unit, time, outcome, treatment time, and covariates.

2. Call `estimate_fat()`, specifying the unit and time variables, outcome variable, treatment year, degrees of polynomial, and forecast horizon. The function will fit a polynomial trend to pre-treatment data, forecast the counterfactual outcomes, and compute the average treatment effect.
The output contains:
  - `results_fat$results`: A table of FAT estimates and standard errors for each (degree, horizon) combination.
  - `results_fat$predictions`: Unit-level observed and forecasted values, useful for plotting and diagnostics.

3. Visualise results (optional): 
  - Use `plot_fat()` to visualize the forecasted treatment effects over time.
  - Use `summary_fat()` to get a summary of the estimated treatment effects.



## Model Extensions:

1. Baseline (no covariates):

All units share a common time trend (polynomial of degree dd).



where $\hat{Y}_{i,\tau_i^* + h}^{(0)}$ is the forecasted outcome using a polynomial trend fitted to pre-treatment data.

```{r example baseline}

```



2. Include Covariates 

Each unit shares a common time trend, but covariates are included to adjust the outcome.

Use when policy variables react to outcomes.

Extensions: IV allows for endogenous covariates. 


```{r iv}

```



2. Heterogeneous Trends 

Each unit gets its own polynomial trend. Use when units are highly heterogeneous and individual dynamics dominate.

$$
FAT(h) = 
$$

```{r heterogenous}

```



3. Difference-in-FAT

Motivation: External shocks may affect all units post-treatment. DFAT compares treated vs. untreated forecasts. 

$$
DFAT(h) = FAT^T(h) - FAT^C(h)
$$

Parameter: 

```{r }

```



# Package Usage

```{r library}
#library(fatEstimation)
```

# Simulated Example

This example demonstrates how to use the package on simulated data:

```{r example}

```

# Interpretation

The function `fat_estimate()` uses a simple polynomial regression on pre-treatment data to forecast the counterfactual outcome. The ATT is then estimated as the average difference between the observed and forecasted outcomes in the post-treatment period.

# References

Botosaru, I., Giacomini, R., & Weidner, M. (2023). *Forecasted Treatment Effects*. Working Paper. Available from authors.
