---
title: "Forecasted Average Treatment Effects"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Forecasted Average Treatment Effects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The `fatEstimator` package implements the *Forecasted Average Treatment Effect Approach* from Botosaru, Giacomini, and Weidner (2024). It is designed for settings where a traditional control group is not available, such as universal policy interventions, endogenous treatment adoption, or policies with no clear comparison group.

The central idea is to construct unit-specific counterfactuals using **forecasting models based on pre-treatment outcomes**, and to define the treatment effect as the deviation of the observed post-treatment outcome from this forecast.

This vignette explains:
- the baseline FAT approach using polynomial trend forecasting,
- its theoretical underpinnings,
- and key extensions including covariates, heterogeneous dynamics, and difference-in-FAT (DFAT).


## Estimation Strategy (Baseline Case)

Let $\tau$ denote the common treatment time. The method estimates the forecasted average treatment effect at horizon $h$ as:

$$
\widehat{FAT_h} := \frac{1}{n} \sum_{i \in n} [Y_{i \tau + h} - \widehat{Y}_{i \tau + h}(0)]
$$
where:

- $Y_{i \tau + h}$ is the observed outcome for unit $i$ at time $\tau + h$,
- $\widehat{Y}_{i \tau + h}(0)$ is the forecast of what the outcome would have been without treatment.

The forecasts $\widehat{Y}_{i t}(0)$ are obtained using unit-specific time trends (e.g., polynomial functions fitted to pre-treatment outcomes).


### 1.1 Forecasting the Counterfactual

To obtain forecasts, the model fits a polynomial basis function regression to the pre-treatment data, using the following form (equation (10) in the paper):

$$
Y_{it} = \sum_{k=0}^{q_i} \beta_{ik} b_k(t - \tau) + \varepsilon_{it}, \quad t < \tau
$$

Where:
- $b_k(t - \tau) = (t - \tau)^k$ for polynomial basis functions.
- $q_i$ is the polynomial degree.
- $\tau$ is the treatment time for unit $i$.

The forecast at horizon $h$ becomes (equation (11)):

$$
\widehat{Y}_{i, \tau + h}(0) = \sum_{k = 0}^{q_i} \widehat{\beta}_{ik} b_k(h)
$$

This forecast is used to estimate the FAT by comparing it to observed post-treatment outcomes.

######################################

The counterfactual $\widehat{y}_{i, \tau + h}(0)$ is constructed using a **basis function regression** fit to the pre-treatment period. The method requires specifying:

- A set of linearly independent basis functions $\{ b_k(t) \}_{k=0}^{q_i}$, e.g., polynomials $b_k(t) = t^k$
- The number of basis functions $q_i$
- The estimation window $T_i = \{ \tau - R_i + 1, \dots, \tau \}$

The fitted forecast is:

$$
\widehat{y}^{(q_i, R_i)}_{i, \tau + h}(0) := \sum_{k=0}^{q_i} \widehat{c}^{(q_i, R_i)}_{ik} \cdot b_k(\tau + h)
$$

The coefficients are estimated by:

$$
\widehat{c}^{(q_i, R_i)}_i := \arg\min_{c \in \mathbb{R}^{q_i + 1}} \sum_{t \in T_i} \left( y_{it} - \sum_{k=0}^{q_i} c_k b_k(t) \right)^2
$$


### 1.2 Theoretical Justification

Under suitable conditions on the data generating process (DGP), the forecast $\widehat{y}_{i, \tau + h}(0)$ is **unbiased on average**, , i.e.: $\mathbb{E}[\widehat{Y}_{i, \tau + h}(0)] = \mathbb{E}[Y_{i, \tau + h}(0)]$, so that the FAT estimator consistently estimates the ATT. 

Thus, the FAT estimator consistently estimates ATT. See Theorem 1â€“2 in Botosaru et al. (2024).

In particular:

- If the DGP includes **stationary or stochastic trends**, any weighted average of pre-treatment outcomes (with weights summing to 1) is unbiased (Theorem 1).
- If the DGP includes **deterministic trends**, basis function regressions remain unbiased provided the true trend is contained in the span of $\{ b_k(t) \}$ and $q_i \geq q_{0i}$ (Theorem 2).

Thus, polynomial regressions of modest order (e.g., $q_i = 0, 1, 2, 3$) offer a flexible and theoretically valid basis for forecasting the counterfactuals.

### Implementation Notes

- In the baseline setting of the package, a common reference time $\tau$ is used across all units.
- Polynomial basis functions $b_k(t) = t^k$ are used by default.
- The user can vary the degree $q_i$ and pre-treatment window $R_i$.
- The FAT estimator outputs the estimated effects $\widehat{\text{FAT}}_h$ for $h = 1, 2, \dots$.


### Assumptions and Key Features

- **Forecast Unbiasedness**: Counterfactual forecasts must be unbiased on average.
- **Weak Dependence**: Forecast errors must satisfy a central limit theorem.
- **Basis Function Forecasting**: Forecasts are based on regressions using basis functions (e.g., polynomials).
- **Short Panel**: Identification and inference do not require long time series. 


### Practical Advice

- Plot pre-treatment series to visually assess trends.
  - Pick degree = 0 if flat, 1 if linear, etc.
- Placebo checks: Apply the FAT estimator to fake horizons **before** treatment. If estimates are near zero, that supports the unbiasedness assumption.
- Be cautious: this baseline case does not account for:
  - Common unforecastable shocks,
  - covariates (e.g., time-varying factors),
  - or staggered treatment with anticipation. 

## Demonstration Example 
The function `estimate_fat()` fits a polynomial trend to pre-treatment data, forecasts counterfactual outcomes, and computes the average treatment effect.


```{r example, echo=FALSE}
# results_fat <- estimate_fat(
#   data = my_data,
#   unit_var = "unit_id",
#   time_var = "year",
#   outcome_var = "outcome",
#   treat_time_var = "treat_year",
#   degrees = 0:2,           # Try multiple polynomial degrees
#   horizons = 1:5,          # Forecast 1 to 5 years after treatment
#   beta_estimator = "none"   # Pooled polynomial fit
# )
```




## Model Extensions:

The FAT estimator can be extended to handle more complex scenarios:

1. Include Covariates 

Each unit shares a common time trend, but covariates are included to adjust the outcome. Use when policy variables react to outcomes.
Extensions: IV allows for endogenous covariates. 

$$
y_{it}(0) = x_{it}'\beta + \sum_{k=0}^{q_i} c_{ik} t^k + \varepsilon_{it} \tag{16}
$$


2. Heterogeneous Trends 

Each unit gets its own polynomial trend. Use when units are highly heterogeneous and individual dynamics dominate. This is set by the beta_estimator = "unitwise" option in the function.



3. Difference-in-FAT

Motivation: External shocks may affect all units post-treatment. DFAT compares treated vs. untreated forecasts. 

$$
DFAT(h) = FAT^T(h) - FAT^C(h)
$$



## Package Usage

```{r library}
#library(fatEstimation)
```

### Application steps

1. Prepare the data in long format with columns for unit, time, outcome, treatment time, and covariates.

2. Call `estimate_fat()`, specifying the unit and time variables, outcome variable, treatment year, degrees of polynomial, and forecast horizon. The function will fit a polynomial trend to pre-treatment data, forecast the counterfactual outcomes, and compute the average treatment effect.
The output contains:
  - `results_fat$results`: A table of FAT estimates and standard errors for each (degree, horizon) combination.
  - `results_fat$predictions`: Unit-level observed and forecasted values, useful for plotting and diagnostics.

3. Visualise results (optional): 
  - Use `plot_fat()` to visualize the forecasted treatment effects over time.
  - Use `summary_fat()` to get a summary of the estimated treatment effects.

### Key user input

To implement the baseline FAT estimator, the researcher must define:

- *unit_var*: identifier for each observational unit (e.g., municipality or region).
- *time_var*: the time dimension (e.g., "year").
- *outcome_var*: the dependent variable to forecast.
- *treat_time_var*: treatment adoption year per unit.
- *degrees*: a vector of polynomial degrees (e.g., 0:2) to fit as pre-trends.
- *horizons*: a vector of forecast horizons after treatment (e.g., 1:3).
- *beta_estimator* = "none", "ols", "iv", "unitwise": 
  - "none" for no covariates,
  - "ols" for pooled polynomial fit,
  - "iv" for instrumental variable estimation,
  - "unitwise" for unit-specific trends.



#### Simulated Example

This example demonstrates how to use the package on simulated data:

```{r}


```


### Interpretation

The function `fat_estimate()` uses a simple polynomial regression on pre-treatment data to forecast the counterfactual outcome. The ATT is then estimated as the average difference between the observed and forecasted outcomes in the post-treatment period.

### Advantages

- No control group needed.
- Allows for heterogeneous treatment effects.
- Robust to model misspecification.
- Compatible with short time series.


# References

Botosaru, I., Giacomini, R., & Weidner, M. (2024). Forecasted Average Treatment Effects in the Absence of a Control Group. Journal / arXiv, 2024.
(Ensure correct citation details once journal info is finalized.)
Paper version used: 2024 working paper. 
