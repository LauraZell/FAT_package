---
title: "Forecasted Average Treatment Effects"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Forecasted Average Treatment Effects}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

The `fatEstimator` package implements the *Forecasted Average Treatment Effect Approach* from Botosaru, Giacomini, and Weidner (2024). It is designed for settings where a traditional control group is not available, such as universal policy interventions, endogenous treatment adoption, or policies with no clear comparison group. Additionally, the approach can be a useful robustness check for settings with a control group, especially when its validity is questionable or the assumptions of the existing methods are too strong to be credible.

The central idea is to construct unit-specific counterfactuals using **forecasting models based on pre-treatment outcomes**, and to define the treatment effect as the deviation of the observed post-treatment outcome from this forecast.

This vignette explains:
- the baseline FAT approach using polynomial trend forecasting,
- its theoretical underpinnings,
- and key extensions including covariates, heterogeneous dynamics, and difference-in-FAT (DFAT).


## 1. Estimation Strategy (Baseline Case)

Let $\tau$ denote the common treatment time. The method estimates the forecasted average treatment effect at horizon $h$ as:

$$
\widehat{FAT_h} := \frac{1}{n} \sum_{i \in n} [Y_{i \tau + h} - \widehat{Y}_{i \tau + h}(0)] \tag{1}
$$
where:

- $Y_{i \tau + h}$ is the observed outcome for unit $i$ at time $\tau + h$,
- $\widehat{Y}_{i \tau + h}(0)$ is the forecast of what the outcome would have been without treatment.

The forecasts $\widehat{Y}_{i t}(0)$ are obtained using unit-specific time trends (e.g., polynomial functions fitted to pre-treatment outcomes).


### 1.1 Forecasting the Counterfactual

The counterfactual $\widehat{y}_{i, \tau + h}(0)$ is constructed using a **basis function regression** fit to the $R_i$ periods prior to treatment. The method requires specifying:

- A set of linearly independent basis functions $\{ b_k(t) \}_{k=0}^{q_i}$, e.g., polynomials $b_k(t) = t^k$
- The number of basis functions $q_i$
- The estimation window $T_i = \{ \tau - R_i + 1, \dots, \tau \}$


$$
\widehat{y}_{i \tau + h}^{(q_i, R_i)}(0) = \sum_{k=0}^{q_i} \widehat{c}_{ik}^{(q_i, R_i)} (\tau + h)^k \tag{2}
$$

Where:

- $q_i$ is the polynomial degree.
- $\tau$ is the treatment time for unit $i$.


The coefficients $\widehat{c}_i = (\widehat{c}_{i0}, ..., \widehat{c}_{iq_i})$ are estimated by minimizing the squared error over the pre-treatment window $T_i = \{\tau - R_i + 1, ..., \tau\}$:

$$
\widehat{c}^{(q_i, R_i)}_i = \arg\min_{c \in \mathbb{R}^{q_i+1}} \sum_{t \in T_i} \left(y_{it} - \sum_{k=0}^{q_i} c_k t^k\right)^2 \tag{3}
$$


### Side note: the proper equations (delete this if not needed)
The fitted forecast is:

$$
\widehat{y}^{(q_i, R_i)}_{i \tau + h}(0) := \sum_{k=0}^{q_i} \widehat{c}^{(q_i, R_i)}_{ik} \cdot b_k(\tau + h) \tag{2.1}
$$

The coefficients are estimated by:

$$
\widehat{c}^{(q_i, R_i)}_i := \arg\min_{c \in \mathbb{R}^{q_i + 1}} \sum_{t \in T_i} \left( y_{it} - \sum_{k=0}^{q_i} c_k b_k(t) \right)^2 \tag{3.1}
$$

### 1.2 Theoretical Justification

Under suitable conditions on the data generating process (DGP), the forecast $\widehat{y}_{i, \tau + h}(0)$ is **unbiased on average**, , i.e.: $\mathbb{E}[\widehat{Y}_{i, \tau + h}(0)] = \mathbb{E}[Y_{i, \tau + h}(0)]$, so that the FAT estimator consistently estimates the ATT. 

Thus, the FAT estimator consistently estimates ATT. See Theorem 1â€“2 in Botosaru et al. (2024).

In particular:

- If the DGP includes **stationary or stochastic trends**, any weighted average of pre-treatment outcomes (with weights summing to 1) is unbiased (Theorem 1).
- If the DGP includes **deterministic trends**, basis function regressions remain unbiased provided the true trend is contained in the span of $\{ b_k(t) \}$ and $q_i \geq q_{0i}$ (Theorem 2).

Thus, polynomial regressions of modest order (e.g., $q_i = 0, 1, 2, 3$) offer a flexible and theoretically valid basis for forecasting the counterfactuals.

Polynomial basis functions $b_k(t) = t^k$ are used by default.



### Assumptions and Key Features

- **Forecast Unbiasedness**: Counterfactual forecasts must be unbiased on average.
- **Weak Dependence**: Forecast errors must satisfy a central limit theorem.
- **Short Panel**: Identification and inference do not require long time series. 


### Practical Advice
- Choose $q_i$ (polynomial degree) based on data visualization. Use 0 for constant trend, 1 for linear, etc.
- Choose $R_i$ (length of pre-treatment window) large enough to estimate $q_i + 1$ coefficients, but not too large if trends are unstable.
- Placebo checks: Apply the FAT estimator to fake horizons **before** treatment. If estimates are near zero, that supports the unbiasedness assumption.
- Be cautious: this baseline case does not account for:
  - Common unforecastable shocks,
  - covariates (e.g., time-varying factors),
  - or staggered treatment with anticipation. 

## Demonstration Example 
The function `estimate_fat()` fits a polynomial trend to pre-treatment data, forecasts counterfactual outcomes, and computes the average treatment effect.


```{r example, echo=FALSE}
# results_fat <- estimate_fat(
#   data = my_data,
#   unit_var = "unit_id",
#   time_var = "year",
#   outcome_var = "outcome",
#   treat_time_var = "treat_year",
#   degrees = 0:2,           # Try multiple polynomial degrees
#   horizons = 1:5,          # Forecast 1 to 5 years after treatment
#   beta_estimator = "none"   # Pooled polynomial fit
# )
```



## Model Extensions:

The FAT estimator can be extended to handle more complex scenarios:


## 2.1 Covariates with Homogeneous Coefficients (Model-Based FAT)

To incorporate additional covariates $x_{it}$ (e.g., policy drivers, controls), we forecast assume:

$$
y_{it}(0) = x_{it}' \beta + \sum_{k=0}^{q_i} c_{ik} t^k + \varepsilon_{it} \tag{4}
$$

The coefficients $\beta$ are common across units, while $c_{ik}$ remain unit-specific. The forecast becomes:

$$
\widehat{y}_{i \tau + h}^{(q_i, R_i)}(0) = x_{i \tau + h}' \widehat{\beta} + \sum_{k=0}^{q_i} \widehat{c}_{ik} (\tau + h)^k \tag{5}
$$

Where $\widehat{c}_i$ are obtained by regressing $y_{it} - x_{it}'\widehat{\beta}$ on $\{t^k\}$ over $t \in T_i$. The $\widehat{\beta}$ can be estimated using pooled OLS or IV (see below).

This is implemented in the package using `beta_estimator = "ols"` or `"iv"`.

### Use Case
Use this when some covariates (e.g. exogenous controls, lagged outcomes, or instruments) explain common dynamics.

### Requirements
- $x_{it}$ must be observed in all periods.
- Instruments must be supplied if `beta_estimator = "iv"`.


## 2.2 Heterogeneous Coefficients (Unitwise Estimation)

When units are highly heterogeneous, it may be inappropriate to pool data. The package allows estimating the polynomial trend *separately for each unit* without assuming common slopes.

The model is:

$$
y_{i \tau + 1}^{(q_i, R_i)}(0) = \sum_{k=0}^{q_i} c_{ik}^{(q_i, R_i)} (\tau + 1)^k + \widehat{\beta}^{(i)} x_{i \tau + 1} \tag{6}
$$
where $\widehat{\beta}_i$ is the unit-specific coefficient vector estimated from the pre-treatment data.

This is the default behavior if `beta_estimator = "unitwise"`.

### Use Case
Use when units have idiosyncratic dynamics, especially when time series are long enough to estimate per-unit trends.


## 2.3 Difference-in-FAT (DFAT)

Some common shocks may affect all units post-treatment. If untreated units are available, we can estimate a differential FAT:

$$
DFAT_h := FAT_h^{treated} - FAT_h^{control} \tag{7}
$$

The forecast models are fitted separately for both treated and untreated units, and their average deviations from observed outcomes are differenced.

This is implemented by supplying a `treated` column and setting `control_group_value = FALSE`.

### Use Case
Use DFAT when:

- External shocks may bias post-treatment outcomes,
- A control group is available but not suitable for pre-treatment matching.


# 3. Package Usage

```{r library}
# library(fatEstimator)
```

## Application Steps

1. Prepare a long-format dataset with:
   - unit, time, outcome, treatment year, and optionally covariates.
2. Call `estimate_fat()` with appropriate arguments.
3. Interpret:
   - `results$results`: FAT estimates and standard errors for (degree, horizon),
   - `results$predictions`: unit-level observed and forecasted values, useful for plotting and diagnostics,
   - `plot_fat()`: visual summary of FAT,
   - `plot_fat_dfat_trajectories()`: visualizes the pre- and post-treatment of treated (and if applicable) control units over time.

# 4. Simulated Example (to be inserted)

```{r, eval=FALSE}
# Simulated code here
```


### Key user input

To implement the baseline FAT estimator, the researcher must define:

- *unit_var*: identifier for each observational unit (e.g., municipality or region).
- *time_var*: the time dimension (e.g., "year").
- *outcome_var*: the dependent variable to forecast.
- *treat_time_var*: treatment adoption year per unit.
- *degrees*: a vector of polynomial degrees (e.g., 0:2) to fit as pre-trends.
- *horizons*: a vector of forecast horizons after treatment (e.g., 1:3).
- *beta_estimator* = "none", "ols", "iv", "unitwise": 
  - "none" for no covariates,
  - "ols" for pooled polynomial fit,
  - "iv" for instrumental variable estimation,
  - "unitwise" for unit-specific trends.



#### Simulated Example

This example demonstrates how to use the package on simulated data:

```{r}


```



### Advantages

- No control group needed.
- Allows for heterogeneous treatment effects.
- Robust to model misspecification.
- Compatible with short time series.


# References

Botosaru, I., Giacomini, R., & Weidner, M. (2024). Forecasted Average Treatment Effects in the Absence of a Control Group. Journal / arXiv, 2024.
(Ensure correct citation details once journal info is finalized.)
Paper version used: 2024 working paper. 
