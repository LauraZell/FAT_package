# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
outcome_var = "ln_age_mort_rate",
treat_time_var = "adopt_year",
degrees = 0:2,
hh = 3,
lags = 0:2,
beta_estimator = "none",
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
outcome_var = "ln_age_mort_rate",
treat_time_var = "adopt_year",
degrees = 0:2,
hh = 3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
hh = 3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_year_var = "adopt_year"
outcome_var = "ln_age_mort_rate",
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_year_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
hh = 3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_year_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
horizons = 1:3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
devtools::document()
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_year_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
horizons = 1:3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_time_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
horizons = 1:3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
devtools::document()
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_time_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
horizons = 1:3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
devtools::document()
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_time_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
horizons = 1:3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
devtools::document()
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_time_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
horizons = 1:3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
devtools::document()
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_time_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
horizons = 1:3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
devtools::document()
# ----------------------------------------------- #
# with DFAT:
placebo_dfat <- estimate_placebo_fat(
data = sim_data_with_controls,
unit_var = "state",
time_var = "Year",
treat_time_var = "adopt_year",
outcome_var = "ln_age_mort_rate",
degrees = 0:2,
horizons = 1:3,
lags = 0:2,
control_group_value = FALSE,   # assumes treated == TRUE/FALSE in your data
forecast_lag = 0,
pretreatment_window = "minimal"
)
devtools::document()
placebo_out <- estimate_placebo_fat(
data               = panel_df,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 0:3,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("income", "unemployment"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= NULL,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_out <- estimate_placebo_fat(
data               = sim_data,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 0:3,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("income", "unemployment"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= NULL,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_out <- estimate_placebo_fat(
data               = sim_data,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 0:3,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= NULL,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 0:3,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 0:3,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 0:3,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
beta_estimator     = "none",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 0:3,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "none",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 0:3,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 1,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 2,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
plot_fat_dfat_avg_trajectory <- function(predictions_df, mode = c("fat", "dfat"),
unit_var = "state", time_var = "Year",
outcome_var = "ln_age_mort_rate", pred_var = "preds") {
mode <- match.arg(mode)
library(dplyr)
library(ggplot2)
# Label treatment group
if (mode == "dfat") {
if (!"treated" %in% names(predictions_df)) stop("DFAT mode requires a 'treated' column.")
predictions_df <- predictions_df %>%
mutate(group = ifelse(treated == 1, "Treated", "Control"))
} else {
predictions_df$group <- "Treated"
}
# Aggregate: mean over units, by Year × group × deg
agg_df <- predictions_df %>%
group_by(Year, group, deg) %>%
summarise(
obs = mean(.data[[outcome_var]], na.rm = TRUE),
pred = mean(.data[[pred_var]], na.rm = TRUE),
.groups = "drop"
) %>%
tidyr::pivot_longer(cols = c("obs", "pred"),
names_to = "type",
values_to = "value")
# Plot: Average observed and predicted for each group
ggplot(agg_df, aes(x = Year, y = value, color = type, linetype = type)) +
geom_line(size = 1.1) +
facet_wrap(~ group + deg, ncol = 2, labeller = label_both) +
scale_color_manual(values = c("obs" = "black", "pred" = "blue"),
labels = c("Observed", "Forecasted")) +
scale_linetype_manual(values = c("obs" = "solid", "pred" = "dashed")) +
scale_x_continuous(breaks = scales::pretty_breaks(), labels = scales::number_format(accuracy = 1)) +
theme_minimal(base_size = 13) +
theme(legend.position = "bottom") +
labs(
title = paste0("Average Outcome Trajectories (", toupper(mode), " Mode)"),
subtitle = "Solid = Observed, Dashed = Forecasted | Facets: Group × Degree",
x = "Year",
y = outcome_var,
color = "Line Type",
linetype = "Line Type"
)
}
devtools::document()
plot_fat_ci(fat_out$results, title = "FAT with 95% CI")
plot_fat_ci(res_full$results, title = "FAT with 95% CI")
plot_fat_ci(placebo_all$results, title = "FAT with 95% CI")
plot_fat_ci(placebo_out$results, title = "FAT with 95% CI")
plot_fat_ci(placebo_out$results, llag = 2, title = "FAT with 95% CI")
plot_fat_ci(res_full$results, title = "FAT with 95% CI")
plot_fat_ci(res_min$results, title = "FAT with 95% CI")
devtools::document()
plot_fat_dfat_trajectories(predictions_df = res_min$predictions, mode = "fat")
plot_fat_dfat_trajectories(predictions_df = res_min$predictions)
plot_fat_dfat_trajectories(predictions_df = res_dfat$predictions, mode = "dfat")
devtools::document()
devtools::document()
plot_fat_ci(res_min$results, title = "FAT with 95% CI")
plot_fat_ci(res_full$results, title = "FAT with 95% CI")
plot_fat_ci(placebo_out$results, llag = 2, title = "FAT with 95% CI")
plot_fat_ci(placebo_out$results, title = "FAT with 95% CI")
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 2,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
View(placebo_dfat_out)
plot_fat_ci(placebo_dfat_out$results, title = "FAT with 95% CI")
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 2,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
plot_fat_ci(placebo_dfat_out$results, title = "FAT with 95% CI")
devtools::document()
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 2,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
placebo_dfat_out <- estimate_placebo_fat(
data               = sim_data_with_controls,
unit_var           = "state",
time_var           = "Year",
outcome_var        = "ln_age_mort_rate",
treat_time_var     = "adopt_year",
degrees            = 0:3,
horizons           = 1:5,
lags               = 2,                 # test treatment shifted 0..3 years earlier
se_method          = "analytic",
covariate_vars     = c("covariate1", "covariate2"),
beta_estimator     = "ols",               # or "iv", "unitwise", "none"
min_iv_lag         = 2,
max_iv_lag         = 2,
control_group_value= FALSE,                # set e.g. FALSE to switch to DFAT mode
forecast_lag       = 0,
pretreatment_window= "full"
)
